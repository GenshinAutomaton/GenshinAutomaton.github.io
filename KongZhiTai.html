<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原神自动机</title>
    <link rel="icon" type="image/x-icon" href="static/image/goTop.png"/>
    <link rel="stylesheet" href="static/css/home.css">
    <link rel="stylesheet" href="static/css/KongZhiTai.css">
    <link rel="stylesheet" href="static/css/header.css">
    <link rel="stylesheet" href="static/css/footer.css">
    <link rel="stylesheet" href="static/css/login.css">
    <link rel="stylesheet" href="static/css/tip.css">
    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->

    <link rel="stylesheet" href="static/css/font.css">
    <link rel="stylesheet" href="static/css/animate.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.css">
    <!-- <link rel="stylesheet" href="static/css/chunk-element.b496abee.css"> -->
    <link rel="stylesheet" href="static/css/openWindow.css">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v3.0.6/css/line.css">
</head>
<body>
    <section class="preloader">
        <div class="sk-circle">
            <div class="sk-circle1 sk-child"></div>
            <div class="sk-circle2 sk-child"></div>
            <div class="sk-circle3 sk-child"></div>
            <div class="sk-circle4 sk-child"></div>
            <div class="sk-circle5 sk-child"></div>
            <div class="sk-circle6 sk-child"></div>
            <div class="sk-circle7 sk-child"></div>
            <div class="sk-circle8 sk-child"></div>
            <div class="sk-circle9 sk-child"></div>
            <div class="sk-circle10 sk-child"></div>
            <div class="sk-circle11 sk-child"></div>
            <div class="sk-circle12 sk-child"></div>
        </div>
    </section>
    <div class="header">
        <div class="header__navbar">
            <div class="box"><a href="index.html">首&nbsp页</a></div>
            <div class="box"><a href="MiJing.html">秘&nbsp境</a></div>
            <div class="box"><a href="KongZhiTai.html">控&nbsp制&nbsp台</a></div>
            <div class="box"><a href="about.html">关&nbsp于</a></div>
            <div class="shell login">
                <div class="login__header box" >
                    <a id="user">登&nbsp录</a>
                </div>
                <img class="login__img" src="static/image/登录.png">
            </div>
            <div class="login__sub">
                <li onclick="logOut()">退出登录</li>
                <li onclick="renew()">续订邮箱推送</li>
                <li onclick="{$('.popup2').addClass('show');}">读取储存秘境</li>
                <li onclick="{
                            $('.task').each(function (value, index) {
                        deleteCookie($(this).text());
                        deleteCookie(($(this).text()).concat('finish'));
                        $(this).fadeOut(function () {
                        $(this).remove();
                        });
                        });
                        $('.doingTask').each(function (value, index) {
                        deleteCookie(($(this).text()).concat('doing'));
                        $(this).fadeOut(function () {
                        $(this).remove();
                        });
                        });
                        deleteCookie('frontResult');
                        refrushTask();

                        }">强制删除秘境列表
                </li>
            </div>
        </div>

        <div class="mhy-account-flow mhy-account-flow-dialog ys-theme is-pc" style="display: none;" id="login">
            <div class="mhy-account-flow-dialog-content" id="login1">
                <div class="mhy-account-flow-login">
                    <img src="static/image/X.png" class="close-icon">
                </div>
                <div class="mhy-account-flow-tabs tabs-flex">
                    <div class="tab-item active">
                        <span id="yzmloginers">验证码登录</span>
                    </div>
                    <div class="tab-item ">
                        <span id="mimaloginers">密码登录</span>
                    </div>
                </div>
                <div class="mhy-account-flow-form-input">
                    <div class="input-container">
                        <input type="tel" placeholder="邮箱" id="containerinput" maxlength="20">
                    </div>
                    <p class="error-text">*邮箱不能为空</p>
                    <p class="error-text" style="display: none;" id="MobilePhoneFormat">*邮箱格式错误</p>
                </div>
                <div class="mhy-account-flow-form-input">
                    <div class="input-container">
                        <div class="mhy-toast" style="display: none;">请输入正确的邮箱地址</div>
                        <input id="mimaInput" type="tel" placeholder="验证码" maxlength="12">
                        <div onclick="getVerifyCode()" class="input-inner-btn captcha-login-inner-btn" id="VerificationCode">
                            获取验证码
                        </div>
                    </div>
                </div>
                <div></div>
                <div class="mhy-login-button">
                    <button id="LoginFirst" onclick="toLoginFirst()" type="submit" class="login-btn">登录</button>
                </div>
                <div class="register-bar" style="display: none">
                    <a href="javascript:openRegister()" class="to-register">立即注册</a>
                </div>
            </div>
        </div>
        <div class="mhy-account-flow mhy-account-flow-dialog ys-theme is-pc" style="display: none;" id="resister">
            <div class="mhy-account-flow-dialog-content" id="login2">
                <div class="mhy-account-flow-login">
                    <img src="static/image/X.png" class="close-icon">
                </div>
                <div class="mhy-account-flow-tabs tabs-flex">
                    <div class="tab-item active" >
                        <span id="yzmloginers1">密码注册</span>
                    </div>
                </div>
                <div class="mhy-account-flow-form-input">
                    <div class="input-container">
                        <input type="tel" placeholder="邮箱" id="containerinput1" maxlength="20">
                    </div>
                    <p class="error-text">*邮箱不能为空</p>
                    <p class="error-text" style="display: none;" id="MobilePhoneFormat1">*邮箱格式错误</p>
                </div>
                <div class="mhy-account-flow-form-input">
                    <div class="input-container">
                        <div class="mhy-toast" style="display: none;">请输入正确的邮箱地址</div>
                        <input id="mimaInput1" type="tel" placeholder="密码" maxlength="12">
                        <div onclick="getVerifyCode()" class="input-inner-btn captcha-login-inner-btn" id="VerificationCode2">
                            获取验证码
                        </div>
                    </div>
                </div>
                <div class="mhy-account-flow-form-input">
                    <div class="input-container">
                        <div class="mhy-toast" style="display: none;">请输入正确的邮箱地址</div>
                        <input id="mimaInput2" type="tel" placeholder="验证码" maxlength="6">

                    </div>
                </div>
                <div></div>
                <div class="mhy-login-button">
                    <button onclick="toRegister()" type="submit" class="login-btn">注册</button>
                </div>
                <div class="register-bar" style="display: none">
                    <a href="javascript:openLogin()" class="to-register">立即登录</a>
                </div>
            </div>
        </div>
    </div>
    <img class="left_img lr" style="z-index: -100" src="static/image/left.png">
    <img class="right_img lr" style="z-index: -100" src="static/image/right.png">
    <div role="alert" class="el-message el-message--warning tip" style="z-index: 2112;">
        <p class="el-message__content">已经添加到控制台</p>
    </div>
    <div class="container" data-num='5'>
        <div class="notcomp">
            <h3>未执行的秘境</h3>
        </div>
        <div class="doing">
            <h3>正在执行的秘境</h3>
        </div>
        <div class="comp">
            <h3>已执行的秘境</h3>
        </div>
        <a href="javascript:execTask()" class="btn3">开 始 执 行 秘 境</a>
    </div>


    <div class="popup">
        <header>
            <span class="open-span">第一次使用需要下载脚本环境</span>
            <div class="close"><i class="uil uil-times"></i></div>
        </header>
        <div class="content">
            <p>是否下载：</p>
            <ul class="icons">
                <a class="open-a" id="download"><i class="fa fa-check"></i></a>
                <a class="open-a " onclick="closeDownLoad()"><i class="fa fa-close"></i></a>
            </ul>
            <p class="open-p">如果已经下载：</p>
            <div class="field">
                <i class="url-icon uil uil-link"></i>
                <input class="open-input" type="text" value="输入文件夹路径">
                <input id="file" type="file" webkitdirectory multiple/><br>
                <input value="√" type="button" onclick="clickFile()" class="open-button"></input>
            </div>
        </div>
    </div>

    <div class="popup2">
        <header>
            <span class="open-span" style="font-size: 18px">是否要使用上次保存的秘境列表?</span>
        </header>
        <div class="content">
            <ul class="icons">
                <a class="open-a" onclick="{
                    otherGetList();
                }"><i class="fa fa-check"></i></a>
                <a class="open-a " onclick="closeDownLoad2()" href="#"><i class="fa fa-close"></i></a>
            </ul>
        </div>
    </div>

    <script>
        function closeDownLoad() {
            popup.classList.toggle("show");
        }
        function closeDownLoad2() {
            popup2.classList.toggle("show");
        }
        function clickFile() {
            let path = $(".open-input").val();
            if (path.length === 0 || path === "输入文件夹路径") {
                execTip("请输入脚本环境文件夹路径");
                execTasks.length = 0;
            } else {
                if (!path.endsWith("\\environment")) {
                    execTip("脚本环境路径有误，请确保打开的是/environment");
                    execTasks.length = 0;
                    return;
                }
                execTip("即将开始执行任务: " + execTasks);
                execTasks.length = 0;
                if (/.*[\u4e00-\u9fa5]+.*$/.test(path)) {
                    execTip("脚本路径不能存在中文，请移动environment的位置");
                    return;
                }

                let newPath = "python test.py --json \"{\\\"ins\\\":{"
                execTasksIndex.forEach(function (value, index) {
                    if (index < execTasksIndex.length - 1) {
                        newPath = newPath.concat("\\\"" + value + "\\\":\\\"" + execTasksNumber[index] + "\\\",");
                    } else {
                        newPath = newPath.concat("\\\"" + value + "\\\":\\\"" + execTasksNumber[index] + "\\\"");
                    }
                });

                $.ajax({  //验证身份
                    type: "get",
                    url: '/api/user/getUserDetails',
                    async: false,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true,
                    },
                    success: function (data) {
                        if (data.code === 200) {
                            username = data.data.username;
                            newPath = newPath.concat("},\\\"user\\\": \\\"" + username + "\\\",\\\"pwd\\\": \\\"Lmq1226lmq\\\"}\"\n");

                            if (path.startsWith("C:")) {
                                download("start.bat",
                                    "cd " + path + "\n" +
                                    newPath
                                );
                            } else if (path.startsWith("D:")) {
                                download("start.bat", "d:\n" +
                                    "cd " + path + "\n" +
                                    newPath
                                );
                            }
                        } else if (data.code === 401) {
                            execTip("请先登录!")
                        } else if (data.code !== 200) {
                            execTip(data.message);
                        }
                    },
                    error: function () {
                        window.location = "../../500page.html";
                    },
                });
            }
        }

        // const viewBtn = document.querySelector(".btn3"),
        popup = document.querySelector(".popup"),
            popup2 = document.querySelector(".popup2"),
            close = popup.querySelector(".close"),
            field = popup.querySelector(".field"),
            input = field.querySelector("input"),
            copy = field.querySelector(".open-input");


        close.onclick = () => {
            popup.classList.remove("show");
            popup2.classList.remove("show");
        }

        copy.onclick = () => {
            input.select(); //select input value

            field.classList.add("active");
            copy.innerText = "Copied";
            setTimeout(() => {
                window.getSelection().removeAllRanges(); //remove selection from document
                field.classList.remove("active");
                copy.innerText = "Copy";
            }, 6000);

        }
    </script>
    <script type="text/javascript">
        let isFirst = true;
        var numbers = [];
        var mapKey = [];
        var mapValue = [];
        var mapDoing = [];

        $(function () {
            init = 0;
            names.forEach(function (value, index, array) {
                let cookie = getCookie(value);
                if (cookie !== "" && cookie !== -1) {
                    mapKey.push(index);
                    mapValue.push(init);
                    init = init + 1;

                    numbers.push(cookie);
                    var task = $("<div class='task' data-num='1'></div>").text(value);
                    var del = $("<i class='fas fa-trash-alt'></i>").click(function (){
                        if (!checkIsStarting()) {

                            $(this).attr("id", value);
                            var p = $(this).parent();
                            p.attr("id", value);


                            deleteCookie($(this).attr("id"));
                            p.fadeOut(function () {
                                p.remove();
                            });
                        } else {
                            execTip("当前脚本正在进行，请结束脚本并重试!");
                        }
                    });

                    var plus = $("<i class='fas fa-plus'></i>").click(function () {
                        if (!checkIsStarting()) {
                            setCookieValueAdd(value);
                            refreshTaskNumber();
                        } else {
                            execTip("当前脚本正在进行，请结束脚本并重试!");
                        }
                    });
                    var minus = $("<i class='fas fa-minus'></i>").click(function () {
                        if (!checkIsStarting()) {
                            setCookieValueMinus(value);
                            refreshTaskNumber();
                        } else {
                            execTip("当前脚本正在进行，请结束脚本并重试!");
                        }
                    });

                    var demo = $("<i class='fas fa-minus doing' style='display: none'></i>");
                    var doing = demo.click(function () {
                        taskDoing(index);
                    });
                    mapDoing.push(demo);

                    if (cookie !== "" && cookie === "-1") {
                        task.append(del);
                        $(".comp").append(task);
                    } else {
                        task.append(del, plus, minus);
                        $(".notcomp").append(task);
                    }
                }
            });

            names.forEach(function (value, index, array) {
                let cookie = getCookie(value.concat("doing"));
                if (cookie !== "") {
                    var task = $("<div class='doingTask' ></div>").text(value);

                    if (cookie !== "" && cookie === "-1") {
                        task.append(del);
                        $(".comp").append(task);
                    } else {
                        $(".doing").append(task);
                    }
                }
            });

            names.forEach(function (value, index, array) {
                let cookie = getCookie(value.concat("finish"));
                if (cookie !== "") {
                    numbers.push(cookie);

                    var task = $("<div class='task' data-num='1'></div>").text(value);
                    var del = $("<i class='fas fa-trash-alt'></i>").click(function () {
                        if (!checkIsStarting()) {

                            $(this).attr("id", value);
                            var p = $(this).parent();
                            p.attr("id", value.concat("finish"));

                            deleteCookie($(this).attr("id"));
                            p.fadeOut(function () {
                                p.remove();
                            });
                        } else {
                            execTip("当前脚本正在进行，请结束脚本并重试!");
                        }
                    });

                    if (cookie !== "" && cookie === "-1") {
                        task.append(del);
                        $(".comp").append(task);
                    } else {
                        task.append(del);
                        $(".comp").append(task);
                    }
                }
            });

            setTimeout(function () {
                $(".task").each(function (index) {
                    if (numbers[index] != -2) {
                        $(this).attr("data-num", numbers[index]);

                    }
                });
            }, 500);

            if (numbers.length === 0) {
                if (numbers.length === 0) {
                    getFrontList();
                /*
                    //如果没有正在进行，再从数据库中拿
                    //当前没有任何秘境，尝试从用户数据库中获取
                    $.ajax({  //验证身份
                        type: "get",
                        url: '/api/auth/guest/isGuest',
                        async: false,
                        dataType: "json",
                        xhrFields: {
                            withCredentials: true,
                        },
                        success: function (data) {
                            if (data.code === 200) {

                                //先看有没有正在进行中退出了，读取一下上次的进度
                                getStatus();
                                if (numbers.length === 0) {
                                    popup2.classList.toggle("show");
                                    selectList();
                                } else {
                                    popup2.classList.toggle("show");
                                    $.ajax({  //验证身份
                                        type: "get",
                                        url: '/api/MiJing/selectList',
                                        async: false,
                                        dataType: "json",
                                        xhrFields: {
                                            withCredentials: true,
                                        },
                                        success: function (data) {
                                            if (data.code === 200) {
                                                MiJingDetail = data.data;
                                                list = MiJingDetail.toList;
                                                numberList = MiJingDetail.toNumberList;
                                                popup2.classList.toggle("show");
                                                execTip("已获取用户存储的秘境列表!");
                                                //先将任务标记好
                                                list.forEach(function (value,index) {
                                                    setCookieKeyAndValue(names[value], numberList[index]);
                                                });
                                                //读取已经完成和在进行的任务
                                                names.forEach(function (nameValue) {
                                                    if (getCookie(nameValue.concat("finish")) !== null && getCookie(nameValue.concat("finish")) !== undefined && getCookie(nameValue.concat("finish")) !== "") {
                                                        cookie = getCookie(nameValue.concat("finish"));
                                                        console.info(nameValue + "的cookie: " + cookie);
                                                        list.forEach(function (value, index, array) {
                                                            if (names[value] === nameValue) {
                                                                //先判断是否减为0，减为0就删掉它
                                                                if (numberList[index] - cookie <= 0) {
                                                                    deleteCookie(names[value]);
                                                                    console.info(names[value] + "被删掉");
                                                                } else {
                                                                    //添加到cookie
                                                                    setCookieKeyAndValue(names[value], numberList[index] - cookie);
                                                                    console.info(names[value] + "减少了" + cookie);

                                                                }
                                                            }
                                                        });
                                                    }

                                                });
                                                names.forEach(function (nameValue) {
                                                    if (getCookie(nameValue.concat("doing")) !== null && getCookie(nameValue.concat("doing")) !== undefined && getCookie(nameValue.concat("finish")) !== "") {
                                                        list.forEach(function (value, index, array) {
                                                            if (names[value] === nameValue) {
                                                                //先读出cookie
                                                                cookie = getCookie(nameValue);
                                                                //先判断是否减为0，减为0就删掉它
                                                                if (cookie - 1 <= 0) {
                                                                    deleteCookie(names[value]);
                                                                } else {
                                                                    //添加到cookie
                                                                    setCookieKeyAndValue(names[value], cookie - 1);
                                                                }
                                                            }
                                                        });
                                                    }
                                                });
                                                refrushTask()

                                            } else if (data.code === 401) {
                                                execTip("请先登录!");

                                            } else if (data.code !== 200) {
                                                execTip(data.message);
                                            }
                                        },
                                        error: function () {
                                            window.location = "../../500page.html";
                                        },
                                    });
                                }
                            } else if (data.code === 401) {
                            } else if (data.code !== 200) {
                                execTip(data.message);
                            }
                        },
                    });
                */}
            }

            //查看正在执行的秘境
            setInterval(function () {
                getStatus();
            }, 10000);

            //设置下载按钮
            var downloadButton = $("#download");
            downloadButton.click(function () {
                window.open("/api/download/MiJing");
                popup.classList.remove("show");
            });
            checkIsStarting();
        });

        function refreshTaskNumber() {
            var newNumbers = [];
            names.forEach(function (value, index, array) {
                let cookie = getCookie(value);
                if (cookie !== "") {
                    newNumbers.push(cookie);
                }
            })
            numbers = newNumbers;

            $(".task").each(function (index) {
                $(this).attr("data-num", numbers[index]);
            });
        }

        $(".delete1").click(function () {
            if (!checkIsStarting()) {
                $(".task").each(function (value, index) {
                    deleteCookie($(this).text());
                    deleteCookie(($(this).text()).concat("finish"));
                    $(this).fadeOut(function () {
                        $(this).remove();
                    });
                });
                $(".doingTask").each(function (value, index) {
                    deleteCookie(($(this).text()).concat("doing"));
                    $(this).fadeOut(function () {
                        $(this).remove();
                    });
                });
                deleteCookie('frontResult');

                location.reload(true);
            } else {
                execTip("当前脚本正在进行，请结束脚本并重试!");
            }
        });

    </script>
    <div class="footer wow fadeInUp" data-wow-duration="1s">
        <div class="footer_text">
            <h2 style="color: #000000;">原神脚本声明</h2>
            <p style="color: gray;">
                本软件自发布后所有用户均可免费使用，用户禁止出售本软件。
            </p>
            <p class="copyright-text" style="color: gray;">&copy 2022 GenshinAutomata 版权所有 <a
                    href="https://beian.miit.gov.cn/" target="_blank"
                    style="color: gray;">湘ICP备2022002291号-1</a><br>
                Software Design by GenshinAutomata<br>
            </p>
        </div>
        <div class="footer_text">
            <h2 style="color: #000000;">联系方式</h2>
            <p style="color: gray;">
                QQ群：639227600<br>
                合作QQ：1251031190<br>
                邮箱：lmq122677@qq.com<br>
            </p>
        </div>
    </div>
    <a href="#back-top" class="go-top"><img class="go-top" src="static/image/goTop.png"></a>
    <div class="music">
        <div class="msc_title_bg">
            <h4 class="msc_title">Music Name</h4>
        </div>
        <div class="msc_player">
            <audio src="" volume="0.05"></audio>
            <div class="msc_btns">
                <span class="msc_prev">
                    <img src="static/image/prev.svg">
                </span>
                <span class="msc_play">
                    <img src="static/image/pause.svg">
                </span>
                <span class="msc_next">
                    <img src="static/image/next.svg">
                </span>
            </div>
        </div>
    </div>
</body>
<style>
    .login:hover + .login__sub, .login__sub:hover {
        height: 200px;
        opacity: 1;
        transform: translateY(5px);
    }
</style>
<script src="static/js/index.js"></script>
<script src="static/js/tab_con.js"></script>
<script src="static/js/jquery(2).js"></script>
<script src="static/js/wow.min.js"></script>
<script src="static/js/custom.js"></script>
<script src="static/js/MiJing.js"></script>
<script src="static/js/login.js"></script>
<script src="static/js/jquery.cookie.js"></script>
<script src="static/js/KongZhiTai.js"></script>
<script src="static/js/music.js"></script>
</html>